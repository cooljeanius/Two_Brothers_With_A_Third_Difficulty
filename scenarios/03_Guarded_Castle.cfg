#textdomain wesnoth-tbw

[scenario]
    id=03_Guarded_Castle
    name= _ "Guarded Castle"
    map_data="{~add-ons/Two_Brothers_With_A_Third_Difficulty/maps/03_Guarded_Castle.map}"
    {TURNS 30 27 24}
    next_scenario=04_Return_to_the_Village
    victory_when_enemies_defeated=no

    {DEFAULT_SCHEDULE_DUSK}

    {INTRO_AND_SCENARIO_MUSIC sad.ogg knalgan_theme.ogg}{LET_INTRO_MUSIC_FINISH}
    {EXTRA_SCENARIO_MUSIC     suspense.ogg}
    {EXTRA_SCENARIO_MUSIC     siege_of_laurelmor.ogg}
    {EXTRA_SCENARIO_MUSIC     weight_of_revenge.ogg}

    [story]
        # Diary entries split into two parts until story screens allow vertical scrolling (FR #17492).
        [part]
            # wmllint: local spelling clanless
            story=_"19 V, 363 YW
Excerpt from the journal of Rotharik the Clanless

The last of Mordak’s servants arrived this morning bearing the news of his death, as well as a bundle so well-bound it was barely recognizable as a man. Mordak was always reckless. This whole desperate scheme was his, and I suppose I could blame him for everything that we have suffered through if it still mattered. It was he who brought the wrath of the orcs down on us, too. But all the same, he managed to accomplish what he set out to do. I still cannot believe the finality of what has happened; until now we had always managed to make it through somehow.

We had hoped to deliver the mage to Tairach in return for our lives. I do not know what the warlord wants with this man, but he matches the description. I suppose that Mordak’s plan would have worked perfectly if not for the appearance of the horse warriors. Now they are coming here, led by a man rumored to be this mage’s brother. If that is true, he will stop at nothing, no more than would I if they held Mordak."
        [/part]
        [part]
            story=_ "19 V, 363 YW
Excerpt from the journal of Rotharik the Clanless

I have done what I can to fortify this dilapidated castle. The orcs who came with us stand guard at the gates, and I am gathering all of my servants to me in the inner sanctum. But ill fate awaits. Whether I defeat this horse-warrior or no, the orcs will still come for me; they have been scouring the borderlands and raiding the northern farm country in search of us.

Yet for some reason I fear these brothers more. If Mordak were here it would be different, but we are broken... and these two men are whole. In each other, in the ties that bind them, they have strength."
        [/part]
    [/story]

    {TB_TRACK {JOURNEY_STAGE3}}

    # wmllint: validate-off
    [side]
        side=1
        controller=human
        recruit=Horseman,Bowman,Spearman,Footpad
        {GOLD 170 145 120}
        team_name=good
        user_team_name= _ "Humans"
        {FLAG_VARIANT loyalist}

        # wmllint: recognize Arvith
        {CHARACTER_STATS_ARVITH}

        facing=nw
        shroud=yes
    [/side]
    # wmllint: validate-on

    [side]
        side=2
        controller=ai
#ifdef EASY
        recruit=Skeleton,Skeleton Archer,Vampire Bat,Dark Adept,Ghoul,Walking Corpse
#endif
#ifdef NORMAL
        recruit=Skeleton,Skeleton Archer,Vampire Bat,Ghost,Dark Adept,Ghoul,Walking Corpse
#endif
#ifdef HARD
        recruit=Skeleton,Skeleton Archer,Vampire Bat,Blood Bat,Ghost,Dark Adept,Ghoul,Walking Corpse,Soulless
#endif
        {GOLD 30 40 50}
        {INCOME -2 1 4}

        team_name=evil
        user_team_name= _ "Enemies"
        {FLAG_VARIANT undead}

        type=Dark Sorcerer
        id=Rotharik
        name= _ "Rotharik"
        canrecruit=yes

        facing=sw

        [modifications]
#ifdef EASY
            {TRAIT_WEAK}
#endif
            {TRAIT_INTELLIGENT}
#ifdef HARD
            {TRAIT_DEXTROUS}
            {TRAIT_RESILIENT}
#endif
        [/modifications]

        [unit]
            role=Guard
            id=Guard_leader
            name= _ "Guard"
            type=Assassin
            x,y=28,26
            facing=se
        [/unit]

        [unit]
            role=Guard
            name= _ "Guard"
            type=Bandit
            x,y=30,25
            facing=se
        [/unit]

#ifndef EASY
        [unit]
            role=Guard
            name= _ "Guard"
#ifdef NORMAL
            type=Thug
#else
            type=Bandit
#endif
            x,y=28,24
            facing=se
        [/unit]

        [unit]
            role=Guard
            name= _ "Guard"
#ifdef NORMAL
            type=Thug
#else
            type=Bandit
#endif
            x,y=27,28
            facing=se
        [/unit]
#endif
    [/side]

    [side]
        side=3
        controller=ai
        team_name=evil
        user_team_name=_"Enemies"
        {FLAG_VARIANT6 ragged}
        no_leader=yes

        # Orcish guards
        [unit]
            id=Knago-Brek
            name= _ "Knago-Brek"
            type=Orcish Warrior
            x,y=19,17
            ai_special=guardian
            facing=se
#ifdef EASY
            [modifications]
                {TRAIT_DIM}
                {TRAIT_FERAL_MUSTHAVE}
            [/modifications]
#endif
#ifdef NORMAL
            random_traits=yes
#endif
#ifdef HARD
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_STRONG}
                {TRAIT_FEARLESS}
            [/modifications]
            {IS_LOYAL}
#endif
        [/unit]

        [unit]
            name= _ "Castle Guard"
            type=Orcish Grunt
            x,y=18,16
            ai_special=guardian
            facing=se
        [/unit]

        [unit]
            name= _ "Castle Guard"
            type=Orcish Grunt
            x,y=20,16
            ai_special=guardian
            facing=se
        [/unit]

#ifndef EASY
        [unit]
            name= _ "Castle Guard"
#ifdef NORMAL
            type=Orcish Grunt
#else
            type=Orcish Warrior
#endif
            x,y=15,17
            ai_special=guardian
            facing=se
        [/unit]

        [unit]
            name= _ "Castle Guard"
#ifdef NORMAL
            type=Orcish Grunt
#else
            type=Orcish Warrior
#endif
            x,y=23,17
            ai_special=guardian
            facing=se
        [/unit]
#endif
    [/side]

    # (why not just use STARTING_VILLAGES_ALL instead?)
    {STARTING_VILLAGES 2 100}

    # Place the prison gates:
    {PLACE_IMAGE scenery/gate-rusty-se.png 5 5}
    {PLACE_IMAGE scenery/gate-rusty-sw.png 6 10}

    # Some bones to make it feel more like a stereotypical dungeon:
    {PLACE_IMAGE items/bones.png 5 12}
    {PLACE_IMAGE items/bones.png 9 6}
    {PLACE_IMAGE items/bones.png 2 6}
    {PLACE_IMAGE items/bones.png 9 3}

    # Random evil-overlord furniture (main hall)
    {PLACE_IMAGE "items/dragonstatue.png" 12 2}
    {PLACE_IMAGE "items/dragonstatue.png~FL(horiz)" 26 2}

    # The library (on way to the prison)
#ifdef DEBUG_MODE
    {PLACE_IMAGE items/book3.png 2 9}
    {PLACE_IMAGE items/book4.png 3 9}
#endif

    # Treasure pile (top right)
    {PLACE_IMAGE items/chest-plain-closed.png 34 4}
#ifdef DECORATE_TREASURY
    # (these are ifdef-ed out because I don't think they really fit the feel of the room)
    {PLACE_IMAGE items/ball-blue.png 34 5}
    {PLACE_IMAGE items/ball-green.png 33 4}
    {PLACE_IMAGE items/ball-magenta.png 35 4}
#endif

    # Evil altar (side hall, other branch from treasure pile)
    {PLACE_IMAGE items/altar-evil.png 29 3}
    {PLACE_IMAGE scenery/rune5.png 30 3}
    {PLACE_IMAGE scenery/rune6.png 28 3}

    # The armory (southwest from main hall)
#ifdef DECORATE_ARMORY
    # (these are ifdef-ed out because there are too many of them)
    # (some of them even overlap with one another)
    {PLACE_IMAGE items/brazier.png 10 10}
    {PLACE_IMAGE items/brazier.png 12 11}
    {PLACE_IMAGE items/axe.png 11 10}
    {PLACE_IMAGE items/spear-fancy.png 10 11}
    {PLACE_IMAGE items/buckler.png 10 11}
    {PLACE_IMAGE items/buckler.png 11 11}
    {PLACE_IMAGE "items/axe.png~FL(horiz)" 11 12}
    {PLACE_IMAGE "items/bow.png~FL(horiz)" 10 12}
    {PLACE_IMAGE items/bow-elven.png 12 10}
    {PLACE_IMAGE "items/bow-crystal.png~FL(horiz)" 12 10}
#endif

    # The supply room (southeast from main hall)
#ifdef DECORATE_SUPPLY_ROOM
    {PLACE_IMAGE items/barrel.png 28 11}
    {PLACE_IMAGE items/chest.png 28 12}
    {PLACE_IMAGE items/box.png 27 12}
    {PLACE_IMAGE items/box.png 27 11}
    {PLACE_IMAGE items/potion-green.png 26 10}
#endif

    [time_area]
        x=    0,  1-2,  3-4,  5-6,    7,    8, 9-10,11-12,   13,14-15,   16,   17,   18,   19,   20,   21,   22,23-24,   25,26-27,28-29,30-32,   33,34-35,36-37,   38
        y= 1-10, 1-11, 1-12, 1-13, 1-14, 1-15, 1-16, 1-17, 1-18, 1-15, 1-16, 1-15, 1-15, 1-16, 1-16, 1-16, 1-16, 1-15, 1-18, 1-17, 1-16, 1-12, 1-13, 1-12, 1-11, 1-10
        [time]
            id=indoors_dark_castle
            # po: similar string in the wesnoth-help textdomain
            name= _ "Indoors (dark castle)"
            image=misc/time-schedules/schedule-indoors.png~CS(-60,-45,-10)
            lawful_bonus=-25
            red=-60
            green=-45
            blue=-10
        [/time]
    [/time_area]

    # Make lit stone walls illuminate the hex south of them.
    [time_area]
        x= 2,  2,  3, 10, 13, 14, 15, 15, 18, 20, 23, 23, 25, 24, 28, 34, 34
        y= 9, 10, 10,  8, 13, 16,  9,  3,  3,  3,  3,  9, 13, 16,  7,  7, 10
        [time]
            id=indoors_dark_castle_lit
            # po: similar string in the wesnoth-help textdomain
            name= _ "Indoors (lit)"
            image=misc/time-schedules/schedule-indoors.png~BLIT(misc/tod-bright.png)
            lawful_bonus=0
            red=20
            green=-5
            blue=-10
        [/time]
    [/time_area]

    [event]
        name=prestart

        {STORE_BARAN}

#define ANSWER WHICH
    [if]
        [variable]
            name="{WHICH}_password"
            not_equals=1
        [/variable]
        [variable]
            name="{WHICH}_password"
            not_equals=2
        [/variable]
        [variable]
            name="{WHICH}_password"
            not_equals=3
        [/variable]
        [variable]
            name="{WHICH}_password"
            not_equals=4
        [/variable]
        [then]
            [set_variable]
                name="{WHICH}_password"
                value=1
            [/set_variable]
        [/then]
    [/if]
#enddef

        {ANSWER first}
        {ANSWER second}

#undef ANSWER

        # wmllint: recognize Baran
        [objectives]
            side=1
            [objective]
                [show_if]
                    [not]
                        [have_unit]
                            id=Baran
                        [/have_unit]
                    [/not]
                [/show_if]
                description= _ "Rescue Baran"
                condition=win
            [/objective]
            [objective]
                [show_if]
                    [have_unit]
                        id=Baran
                    [/have_unit]
                    [have_unit]
                        id=Rotharik
                    [/have_unit]
                [/show_if]
                description= _ "Kill the dark sorcerer to get the cell key"
                condition=win
            [/objective]
            [objective]
                [show_if]
                    [have_unit]
                        id=Baran
                    [/have_unit]
                    [not]
                        [have_unit]
                            id=Rotharik
                        [/have_unit]
                    [/not]
                [/show_if]
                description= _ "Move Arvith to the cell with his brother to free him"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Arvith"
                condition=lose
            [/objective]
            [objective]
                [show_if]
                    [have_unit]
                        id=Baran
                    [/have_unit]
                [/show_if]
                description= _ "Death of Baran"
                condition=lose
            [/objective]

            {TURNS_RUN_OUT}

            [gold_carryover]
                bonus=yes
                carryover_percentage={ON_DIFFICULTY 60 50 40}
            [/gold_carryover]

#ifdef EASY
            # po: EASY difficulty; avoid any unnecessary vagueness in this hint (some vagueness will be inevitable here though):
            {HINT ( _ "When facing an unknown situation, take into account details from story and dialog to inform your strategy.") (
                [show_if]
                    [not]
                        [have_unit]
                            id=Baran
                        [/have_unit]
                    [/not]
                [/show_if]
            )}
            # po: EASY difficulty, 2nd hint; avoid all vagueness in this hint:
            {HINT ( _ "The dark sorcerer is a strong unit; attack him with multiple units at once and try to force him off his keep.") (
                [show_if]
                    [have_unit]
                        id=Baran
                    [/have_unit]
                    [have_unit]
                        id=Rotharik
                    [/have_unit]
                [/show_if]
            )}
            # po: EASY difficulty; avoid any unnecessary vagueness in this hint (some vagueness will be inevitable here though):
            {HINT ( _ "Markings or decorations on hexes may indicate something to be found. If you can, it is usually a good idea to investigate.") (
                [show_if]
                    [have_unit]
                        id=Baran
                    [/have_unit]
                    [not]
                        [have_unit]
                            id=Rotharik
                        [/have_unit]
                    [/not]
                [/show_if]
            )}
#endif
#ifdef NORMAL
            # po: NORMAL difficulty, 1st hint; hint should be somewhat vague:
            {HINT ( _ "Hm, I wonder where Baran could be?") (
                [show_if]
                    [not]
                        [have_unit]
                            id=Baran
                        [/have_unit]
                    [/not]
                [/show_if]
            )}
            # po: NORMAL difficulty, 2nd hint; hint should be somewhat vague:
            {HINT ( _ "Beware: the dark sorcerer is a strong unit.") (
                [show_if]
                    [have_unit]
                        id=Baran
                    [/have_unit]
                    [have_unit]
                        id=Rotharik
                    [/have_unit]
                [/show_if]
            )}
            # po: NORMAL difficulty, 3rd hint; hint should be somewhat vague:
            {HINT ( _ "Try investigating hexes with markings or decorations.") (
                [show_if]
                    [have_unit]
                        id=Baran
                    [/have_unit]
                    [not]
                        [have_unit]
                            id=Rotharik
                        [/have_unit]
                    [/not]
                [/show_if]
            )}
#endif
#ifdef HARD
            # po: It is intentional for this hint to just be question marks; since we are on HARD it is supposed to be confusing:
            {HINT ( _ "???") (
                [show_if]
                    [not]
                        [have_unit]
                            id=Baran
                        [/have_unit]
                    [/not]
                [/show_if]
            )}
            # po: HARD difficulty, 2nd hint; hint should be even vaguer than the 2nd NORMAL hint for this scenario:
            {HINT ( _ "The dark sorcerer is strong.") (
                [show_if]
                    [have_unit]
                        id=Baran
                    [/have_unit]
                    [have_unit]
                        id=Rotharik
                    [/have_unit]
                [/show_if]
            )}
            # po: HARD difficulty, 3rd hint; hint should be even vaguer than the 3rd NORMAL hint for this scenario:
            {HINT ( _ "Investigate.") (
                [show_if]
                    [have_unit]
                        id=Baran
                    [/have_unit]
                    [not]
                        [have_unit]
                            id=Rotharik
                        [/have_unit]
                    [/not]
                [/show_if]
            )}
#endif
        [/objectives]

        # Making the gates impassable
        [terrain]
            x=5,6
            y=5,10
            terrain=Uu^Xo
        [/terrain]

#ifdef EASY
        [recall]
            id=Brena
        [/recall]
#else
        # Just in case player is doing the "Change Difficulty" thing when reloading:
        [disallow_recruit]
            side=1
            type=Heavy Infantryman
        [/disallow_recruit]
#ifdef HARD
        [kill]
            id=Brena
            x,y=recall,recall
        [/kill]
#endif
#endif

        {MODIFY_UNIT (side=1) facing nw}
    [/event]

    [event]
        name=start

        [message]
            speaker=narrator
            image="wesnoth-icon.png"
            message= _ "Arvith and his men halt outside of the castle, gazing for a moment at the hulking mass of stone looming in the fog. There is movement in the mist."
        [/message]

        [message]
            speaker=Guard_leader
            message= _ "Halt! Friend or foe? Give the password."
        [/message]

        [message]
            speaker=Arvith
            message= _ "The password is"
            variable=password_picked
            [option]
                # po: spoken by Arvith:
                label= _ "Sithrak!"
            [/option]
            [option]
                # po: spoken by Arvith:
                label= _ "Eleben!"
            [/option]
            [option]
                # po: spoken by Arvith:
                label= _ "Jarlom!"
            [/option]
            [option]
                # po: spoken by Arvith:
                label= _ "Hamik!"
            [/option]
        [/message]

        {VARIABLE first_challenge_result unknown}

        [if]
            [variable]
                name=password_picked
                equals=$first_password
            [/variable]

            [then]
                [message]
                    speaker=Guard_leader
                    message= _ "Pass, friend."
                [/message]
                {VARIABLE first_challenge_result passed}

                [kill]
                    role=Guard
                [/kill]

                [remove_shroud]
                    side=1
                    x=    0,  1-2,  3-4,  5-6,    7,    8, 9-10,11-12,   13,14-15,   16,   17,   18,   19,   20,   21,   22,23-24,   25,26-27,28-29,30-32,   33,34-35,36-37,   38
                    y=11-32,12-32,13-32,14-32,15-32,16-32,17-32,18-32,19-32,18-32,17-32,18-32,17-32,18-32,17-32,18-32,17-32,18-32,19-32,18-32,17-32,13-32,14-32,13-32,12-32,11-32
                [/remove_shroud]

                [message]
                    speaker=Arvith
                    message= _ "The adept didn’t lead us astray after all. I’ll keep my word, distasteful as it may be; cut him loose, and let’s be rid of him."
                [/message]
#ifdef EASY
                [unit]
                    side=1
                    type=Dark Adept
                    id=Muff Toras
                    name= _ "Muff Toras"
                    unrenamable=yes
                    placement=leader
                    # The added '$' did indeed fix things; this appears to work properly now:
                    experience="$(min((10 + $Muff_Toras_store.experience), 40))"
                    [modifications]
                        {TRAIT_LOYAL}
                        {TRAIT_INTELLIGENT}
                    [/modifications]
                    {IS_LOYAL}
                [/unit]

                [message]
                    speaker=Muff Toras
                    # po: EASY difficulty; here Muff Toras is much more polite and servile than he would be on other difficulties:
                    message= _ "Thank you so much for sparing me, Sir Arvith! If I may, please permit to join your forces so that I may redeem myself for having kidnapped your brother!"
                [/message]

                [message]
                    speaker=Arvith
                    message= _ "Fine, if you insist."
                [/message]

                [message]
                    speaker=narrator
                    image=wesnoth-icon.png
                    message= _ "Muff Toras will now fight on your side! He is a <i>Dark Adept</i>, which you should already know about from having faced previously!"
                [/message]
#endif
#ifdef NORMAL
                [unit]
                    side=1
                    type=Dark Adept
                    id=Muff Toras
                    name= _ "Muff Toras"
                    unrenamable=yes
                    placement=leader
                    hitpoints=20 # out of 28 (on this difficulty, he's still slightly wounded from being tied up)
                    # The added '$' did indeed fix things; this appears to work properly now:
                    experience="$(min((5 + ($Muff_Toras_store.experience / 2)), 24))"
                    [modifications]
                        {TRAIT_LOYAL}
                        {TRAIT_INTELLIGENT}
                    [/modifications]
                    {IS_LOYAL}
                [/unit]

                [message]
                    speaker=Muff Toras
                    # po: NORMAL difficulty; here Muff Toras is going more for flattery than for sincere thankfulness:
                    message= _ "Thank you for your mercy, Sir Arvith! Surely a merciful man such as yourself will permit me to join your forces?"
                [/message]

                [role]
                    role=objector
                    trait=loyal
                    # ensure he isn't talking to himself:
                    [not]
                        id=Muff Toras
                    [/not]
                    [auto_recall][/auto_recall]
                    [else]
                        [unit]
                            role=objector
                            side=1
                            type=Peasant
                            placement=leader
                            [modifications]
                                {TRAIT_LOYAL}
                                {TRAIT_DIM}
                            [/modifications]
                            {IS_LOYAL}
                        [/unit]
                    [/else]
                [/role]

                [message]
                    role=objector
                    message= _ "Don't let him! I'll never allow myself to fight alongside a dark magic user like him!"
                [/message]

                [message]
                    speaker=Arvith
                    message= _ "Hm..."
                    [option]
                        # po: spoken by Arvith:
                        message= _ "Very well, Muff Toras! You may join my forces!"
                        [command]
                            [message]
                                speaker=Muff Toras
                                message= _ "Thank you for making the right choice!"
                            [/message]

                            [message]
                                role=objector
                                message= _ "Hmph, that's it! I quit! I'm sorry, Arvith, but my moral beliefs against dark magic compel me to leave!"
                            [/message]

                            [kill]
                                role=objector
                            [/kill]
                        [/command]
                    [/option]
                    [option]
                        # po: spoken by Arvith:
                        message= _ "I'm sorry, Muff Toras, but I must take into account my men's objections."
                        [command]
                            [message]
                                speaker=Arvith
                                message= _ "While I cannot permit you to fight alongside us, I shall still permit you to leave unharmed, however."
                            [/message]

                            [message]
                                speaker=Muff Toras
                                message= _ "Hmph, suit yourself..."
                            [/message]

                            [kill]
                                id=Muff Toras
                            [/kill]

                            [message]
                                role=objector
                                message= _ "Thank you for making the right choice!"
                            [/message]
                        [/command]
                    [/option]
                [/message]
#endif
#ifdef HARD
                [move_unit_fake]
                    type=Dark Adept
                    side=1
                    x=35,19
                    y=31,6
                [/move_unit_fake]

                [unit]
                    side=2
                    type=Dark Adept
                    id=Muff Toras
                    name= _ "Muff Toras"
                    unrenamable=yes
                    x,y=19,6
                    ai_special=guardian
                    # The added '$' did indeed fix things; this appears to work properly now:
                    experience="$(min((15 + $Muff_Toras_store.experience), 45))"
                    [modifications]
                        {TRAIT_LOYAL}
                        {TRAIT_INTELLIGENT}
                    [/modifications]
                    {IS_LOYAL}
                [/unit]

                # FIXME: this event doesn't fire when using debug mode to remove shroud:
                [event]
                    name=sighted
                    [filter]
                        id=Muff Toras
                    [/filter]
                    [filter_second]
                        side=1
                    [/filter_second]

                    [scroll_to_unit]
                        id=Muff Toras
                    [/scroll_to_unit]

                    [message]
                        speaker=Muff Toras
                        # po: imagine this is Metal Gear Solid and Solid Snake has just been caught in a spotlight:
                        message= _ "<span color='red' size='large' font_weight='ultrabold'>!</span>"
                    [/message]

                    [delay]
                        time=500
                    [/delay]

                    [message]
                        speaker=Arvith
                        # po: HARD difficulty, so Muff Toras has had different behavior than on the previous two difficulties:
                        message= _ "You! But you gave us the correct passwords though! Why would you lead us true if you were only planning on betraying us?!"
                    [/message]

                    [message]
                        speaker=Muff Toras
                        message= _ "Hahaha, I tricked you! My plan all along was to lead you into a trap! Hey guards, time to return to duty!"
                    [/message]

                    [move_unit_fake]
                        side=2
                        type=Assassin
                        x=25,28
                        y=25,26
                    [/move_unit_fake]

                    [unit]
                        side=2
                        role=Guard
                        id=Guard_leader
                        name= _ "Guard"
                        type=Assassin
                        x,y=28,26
                    [/unit]

                    [move_unit_fake]
                        side=2
                        type=Bandit
                        x=29,30
                        y=26,25
                    [/move_unit_fake]

                    [unit]
                        side=2
                        role=Guard
                        name= _ "Guard"
                        type=Bandit
                        x,y=30,25
                    [/unit]

                    [move_unit_fake]
                        side=2
                        type=Bandit
                        x=28,28
                        y=25,24
                    [/move_unit_fake]

                    [unit]
                        side=2
                        role=Guard
                        name= _ "Guard"
                        type=Bandit
                        x,y=28,24
                    [/unit]

                    [move_unit_fake]
                        side=2
                        type=Bandit
                        x=27,27
                        y=27,28
                    [/move_unit_fake]

                    [unit]
                        side=2
                        role=Guard
                        name= _ "Guard"
                        type=Bandit
                        x,y=27,28
                    [/unit]

                    [move_unit_fake]
                        side=2
                        type=Rogue
                        x= 7,10,16
                        y=23,21,24
                    [/move_unit_fake]
                    [unit]
                        side=2
                        role=Guard2
                        id=Guard2_leader
                        name= _ "Guard"
                        type=Rogue
                        x,y=16,24
                        animate=no
                    [/unit]

                    [unit]
                        side=2
                        role=Guard2
                        name= _ "Guard"
                        type=Thug
                        x,y=17,24
                    [/unit]

                    [unit]
                        side=2
                        role=Guard2
                        name= _ "Guard"
                        type=Bandit
                        x,y=16,24
                    [/unit]

                    [unit]
                        side=2
                        role=Guard2
                        name= _ "Guard"
                        type=Bandit
                        x,y=17,23
                    [/unit]

                    [message]
                        speaker=Arvith
                        message= _ "Argh, the guards have returned! Watch your backs, men!"
                    [/message]

                    [event]
                        name=attack
                        [filter]
                            side=1
                        [/filter]
                        [filter_second]
                            id=Muff Toras
                        [/filter_second]

                        [message]
                            speaker=Arvith
                            # po: directed at Muff Toras:
                            message= _ "Time to correct my mistake of having left you alive!"
                        [/message]
                    [/event]

                    [event]
                        name=last breath
                        [filter]
                            id=Muff Toras
                        [/filter]

                        [message]
                            speaker=Muff Toras
                            message= _ "Ugh, so much for my trap..."
                        [/message]
                    [/event]
                [/event]
#endif
            [/then]

            [else]
                [message]
                    speaker=Guard_leader
                    message= _ "Wrong! Die!"
                [/message]
                {VARIABLE first_challenge_result failed}
#ifdef EASY
                [switch]
                    variable=first_password
                    [case]
                        value=1
                        {VARIABLE first_pwd_name Sithrak}
                    [/case]
                    [case]
                        value=2
                        {VARIABLE first_pwd_name Eleben}
                    [/case]
                    [case]
                        value=3
                        {VARIABLE first_pwd_name Jarlom}
                    [/case]
                    [case]
                        value=4
                        {VARIABLE first_pwd_name Hamik}
                    [/case]
                [/switch]
                [switch]
                    variable=password_picked
                    [case]
                        value=1
                        {VARIABLE pwd_picked_name Sithrak}
                    [/case]
                    [case]
                        value=2
                        {VARIABLE pwd_picked_name Eleben}
                    [/case]
                    [case]
                        value=3
                        {VARIABLE pwd_picked_name Jarlom}
                    [/case]
                    [case]
                        value=4
                        {VARIABLE pwd_picked_name Hamik}
                    [/case]
                [/switch]
                [message]
                    speaker=narrator
                    image=portraits/humans/dark-adept.png
                    caption= _ "Muff Toras"
                    # po: Muff Toras corrects Arvith; possibilities for the variables are the passwords listed previously:
                    message= _ "You fool! I <b><i>told</i></b> you it was $first_pwd_name|! Where did you even come up with $pwd_picked_name from?!"
                [/message]
                [message]
                    speaker=Arvith
                    # po: directed at Muff Toras:
                    message= _ "Shut up, kidnapper!"
                [/message]
                {CLEAR_VARIABLE first_pwd_name}
                {CLEAR_VARIABLE pwd_picked_name}
#endif
            [/else]
        [/if]
        {CLEAR_VARIABLE password_picked}
    [/event]

#ifdef EASY
    [event]
        name=recruit

        [filter]
            side=1
            type=Heavy Infantryman
        [/filter]

        [message]
            speaker=narrator
            image=$unit.profile
            caption= _ "Tutorial: Heavy Infantryman"
            # po: "In return" here is to contrast a strength against the weaknesses previously mentioned:
            message= _ "You have recruited a <i>Heavy Infantryman</i>. Heavy Infantrymen have bulky armor which makes them slow and easy for enemies to hit. In return, they wield a mace for a melee attack which can deal massive <i>impact</i> damage, which is especially powerful against skeletons."
        [/message]
    [/event]
#endif

    [event]
        name=sighted
        [filter]
            side=3
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        [message]
            speaker=Knago-Brek
            message= _ "Haha! We not kill people for long time. Weapon wants blood. We now kill humans!"
        [/message]

        [message]
            speaker=Arvith
            message= _ "My sword-arm shall have a say in who will do the dying. Come on, men, let’s kill some orcs."
        [/message]

        # FIXME: I'm not quite happy with this scrolling; it should be to SOMETHING in the area,
        # but I'm not quite sure if Knago-Brek is the right unit to scroll to...
        [scroll_to_unit]
            id=Knago-Brek
        [/scroll_to_unit]
    [/event]

    [event]
        name=die
        [filter]
            id=Knago-Brek
        [/filter]

        [message]
            speaker=Arvith
            message= _ "One less braggart orc in the world."
        [/message]

        [message]
            side=1
            [not]
                # wmllint: recognize Baran
                id=Arvith,Baran
            [/not]
            message= _ "Captain, what are <i>orcs</i> doing this far south?"
        [/message]

        [message]
            speaker=Arvith
            message= _ "Good question. Perhaps my brother will have found out."
        [/message]
    [/event]

    [event]
        name=turn 3

        [if]
            [have_unit]
                side=2
                role=Guard
            [/have_unit]
            [then]
                [event]
                    name=turn 6

                    [fire_event]
                        name=second wave
                    [/fire_event]
                    [if]
                        [not]
                            [have_unit]
                                side=2
                                role=Guard
                            [/have_unit]
                        [/not]
                        [then]
                            [fire_event]
                                name=second challenge
                            [/fire_event]
                        [/then]
                    [/if]
                [/event]
            [/then]
            [else]
                [fire_event]
                    name=second wave
                [/fire_event]
                [fire_event]
                    name=second challenge
                [/fire_event]
            [/else]
        [/if]
    [/event]

    [event]
        name=second wave

        [move_unit_fake]
            side=2
            type=Rogue
            x= 7,10,16
            y=23,21,24
        [/move_unit_fake]
        [unit]
            side=2
            role=Guard2
            id=Guard2_leader
            name= _ "Guard"
            type=Rogue
            x,y=16,24
            facing=se
            animate=no
        [/unit]

        [unit]
            side=2
            role=Guard2
            name= _ "Guard"
            type=Thug
            x,y=17,24
            facing=se
        [/unit]

        [unit]
            side=2
            role=Guard2
            name= _ "Guard"
            type=Bandit
            x,y=16,24
            facing=se
        [/unit]

#ifndef EASY
        [unit]
            side=2
            role=Guard2
            name= _ "Guard"
#ifdef NORMAL
            type=Thug
#else
            type=Bandit
#endif
            x,y=17,23
            facing=se
        [/unit]
#endif
    [/event]

    [event]
        name=second challenge

        # Ensure guard is visible:
        [remove_shroud]
            [filter]
                id=Guard2_leader
            [/filter]
            [or]
                [filter_adjacent_location]
                    [filter]
                        id=Guard2_leader
                    [/filter]
                [/filter_adjacent_location]
            [/or]
        [/remove_shroud]
        [message]
            speaker=Guard2_leader
            message= _ "Are you our relief arriving? Does this mean we get to leave here now?"
        [/message]

        [message]
            speaker=Arvith
            message= _ "Um, yes. Fine. You can go."
        [/message]

        [message]
            speaker=Guard2_leader
            message= _ "Um, you’re supposed to give the password."
        [/message]

        [if]
            [have_unit]
                side=1
                id=Muff Toras
            [/have_unit]
            [then]
                [if]
                    [variable]
                        name=first_challenge_result
                        equals=passed
                    [/variable]
                    [then]
                        [message]
                            speaker=Muff Toras
                            message= _ "Don't worry, he knows it, don't you, Arvith?"
                        [/message]
                    [/then]
                    [elseif]
                        # This probably won't be reached, as Muff Toras wouldn't join if player failed first challenge, but just in case:
                        [variable]
                            name=first_challenge_result
                            equals=failed
                        [/variable]
                        [then]
                            [message]
                                speaker=Muff Toras
                                # po: case where player failed first password challenge; "this" time is as in opposed to the previous one:
                                message= _ "You remember what I told you <b><i>this</i></b> time, right, Arvith?"
                            [/message]
                        [/then]
                    [/elseif]
                    [else]
                        [message]
                            speaker=Muff Toras
                            # po: Unhandled case handler; probably unreached:
                            message= _ "Um, you do remember what I told you, right, Arvith?"
                        [/message]
                    [/else]
                [/if]
            [/then]
        [/if]

        [message]
            speaker=Arvith
            message= _ "Oh, of course. I had nearly forgotten."
            variable=password_picked
            [option]
                # po: spoken by Arvith:
                label= _ "Akranbral!"
            [/option]
            [option]
                # po: spoken by Arvith:
                label= _ "Drakanal!"
            [/option]
            [option]
                # po: spoken by Arvith:
                label= _ "Xaskanat!"
            [/option]
            [option]
                # po: spoken by Arvith:
                label= _ "Katklagad!"
            [/option]
        [/message]

        [if]
            [variable]
                name=password_picked
                equals=$second_password
            [/variable]

            [then]
                [message]
                    speaker=Guard2_leader
                    message= _ "Thanks! Irritating little formality, isn’t it?"
                [/message]
                [kill]
                    role=Guard2
                [/kill]
            [/then]

            [else]
                [message]
                    speaker=Guard2_leader
                    message= _ "That’s the wrong password! These aren’t our relief! Get them!"
                [/message]
                [if]
                    [have_unit]
                        side=1
                        id=Muff Toras
                    [/have_unit]
                    [then]
                        [switch]
                            variable=second_password
                            [case]
                                value=1
                                {VARIABLE second_pwd_name Akranbral}
                            [/case]
                            [case]
                                value=2
                                {VARIABLE second_pwd_name Drakanal}
                            [/case]
                            [case]
                                value=3
                                {VARIABLE second_pwd_name Xaskanat}
                            [/case]
                            [case]
                                value=4
                                {VARIABLE second_pwd_name Katklagad}
                            [/case]
                        [/switch]
                        [switch]
                            variable=password_picked
                            [case]
                                value=1
                                {VARIABLE pwd_picked_name Akranbral}
                            [/case]
                            [case]
                                value=2
                                {VARIABLE pwd_picked_name Drakanal}
                            [/case]
                            [case]
                                value=3
                                {VARIABLE pwd_picked_name Xaskanat}
                            [/case]
                            [case]
                                value=4
                                {VARIABLE pwd_picked_name Katklagad}
                            [/case]
                        [/switch]

                        [if]
                            [variable]
                                name=first_challenge_result
                                equals=passed
                            [/variable]
                            [then]
#ifdef EASY
                                [message]
                                    speaker=Muff Toras
                                    # po: EASY difficulty; Muff Toras corrects Arvith; possibilities for the variables are the passwords listed previously:
                                    message= _ "You fool! How could you remember the first password and then forget that I told you that the second one was $second_pwd_name|? Where did you even get $pwd_picked_name from?"
                                [/message]
#else
                                [message]
                                    speaker=Muff Toras
                                    # po: on NORMAL and HARD Muff Toras still yells at you here, but doesn't tell you the correct password:
                                    message= _ "You fool! How could you remember the first password and then forget the second one? Where did you even get $pwd_picked_name from?"
                                [/message]
#endif
                            [/then]
                            [elseif]
                                # This probably won't be reached, as Muff Toras wouldn't join if player failed first challenge, but just in case:
                                [variable]
                                    name=first_challenge_result
                                    equals=failed
                                [/variable]
                                [then]
                                    [message]
                                        speaker=Muff Toras
                                        # po: this is the case where the player failed first password challenge, so Muff Toras is correcting Arvith AGAIN;
                                        # po: possibilities for the variables are the passwords listed previously:
                                        message= _ "You absolute idiot! You forget not only the first password, but also that I told you that the second password was $second_pwd_name|? Where do you even get these wacky ideas for passwords like $pwd_picked_name from? Actually, you know what, I don't even care; I'm out of here."
                                    [/message]
                                    [kill]
                                        side=1
                                        id=Muff Toras
                                    [/kill]
                                [/then]
                            [/elseif]
                            [else]
#ifdef EASY
                                [message]
                                    speaker=Muff Toras
                                    # po: EASY difficulty; Muff Toras corrects Arvith; possibilities for the variables are the passwords listed previously:
                                    message= _ "You fool! I <b><i>told</i></b> you it was $second_pwd_name|! Where did you even come up with $pwd_picked_name from?!"
                                [/message]
#else
                                [message]
                                    speaker=Muff Toras
                                    # po: this line probably won't be reached, but in case it is, "it" refers to the second password that Arvith just forgot:
                                    message= _ "You fool! I had told you what it was, too!"
                                [/message]
#endif
                            [/else]
                        [/if]
                        {CLEAR_VARIABLE second_pwd_name}
                        {CLEAR_VARIABLE pwd_picked_name}
                    [/then]
                [/if]
            [/else]
        [/if]
        {CLEAR_VARIABLE password_picked}

        [message]
            speaker=Arvith
            # po: the "...well, in any case" part is so this line works regardless of what came before it;
            # po: if Muff Toras was yelling at him previously, just assume Arvith is purposefully ignoring him:
            message= _ "...well, in any case, I think I should better support my men at the front to make sure we can free my brother."
        [/message]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Rotharik
        [/filter]

        [if]
            [variable]
                name=second_unit.id
                equals="Muff Toras"
            [/variable]
            [then]
                [message]
                    speaker=Muff Toras
                    # po: Muff Toras has just killed Rotharik and is speaking to him:
                    message= _ "I'm sorry, master, but I have realized the error of my ways in following you. No more! It's time for your schemes to end!"
                [/message]
            [/then]
        [/if]
        [message]
            speaker=unit
            # po: "speaker=unit" is equivalent to "speaker=Rotharik" here (this is his last breath):
            message= _ "Your hand or Tairach’s, death is still death... (argh)"
        [/message]

        [kill]
            id=Rotharik
            animate=yes
        [/kill]

        [message]
            speaker=Arvith
            message= _ "‘Tairach’? Who or what is Tairach?"
        [/message]

        [message]
            speaker=second_unit
            message= _ "There’s a key in his robes."
        [/message]

        [if]
            [have_unit]
                id=Baran
            [/have_unit]
            [then]
                [message]
                    speaker=Arvith
                    message= _ "That may well be the key to the cell they’re holding Baran in! I will take it."
                [/message]

                [store_turns]
                    variable=turns_remaining
                [/store_turns]
                [set_variable]
                    name=turns_remaining
                    sub=$($turn_number| - 1)
                [/set_variable]
                [if]
                    [variable]
                        name=turns_remaining
                        less_than=7
                    [/variable]
                    [then]
                        [modify_turns]
                            add=$(7 - $turns_remaining|)
                        [/modify_turns]
                    [/then]
                [/if]
                {CLEAR_VARIABLE turns_remaining}

                [show_objectives][/show_objectives]
            [/then]
            [else]
                [message]
                    speaker=Arvith
                    message= _ "It may be important, I best take it."
                [/message]
            [/else]
        [/if]
    [/event]

    # When the player can see most of the castle entryway (40 or more castle
    # hexes are unshrouded), comment about the lighting in the castle.
    [event]
        name=moveto
        [filter]
            side=1
            x=    0,  1-2,  3-4,  5-6,    7,    8, 9-10,11-12,   13,14-15,   16,   17,   18,   19,   20,   21,   22,23-24,   25,26-27,28-29,30-32,   33,34-35,36-37,   38
            y= 1-10, 1-11, 1-12, 1-13, 1-14, 1-15, 1-16, 1-17, 1-18, 1-15, 1-16, 1-15, 1-15, 1-16, 1-16, 1-16, 1-16, 1-15, 1-18, 1-17, 1-16, 1-12, 1-13, 1-12, 1-11, 1-10
        [/filter]

        [message]
            speaker=unit
            message= _ "This castle seems as dark as a cave!"
        [/message]

#ifdef EASY
        [message]
            speaker=narrator
            # po: EASY difficulty; avoid all vagueness in this hint:
            message= _ "This castle is under a constant, <i>chaotic</i> time of day (equivalent to permanent night), except for illuminated hexes adjacent to lit stone walls (neutral time of day). Place your units carefully, as your troops will be weaker and enemy units stronger."
            image=wesnoth-icon.png
        [/message]
#endif
#ifdef NORMAL
        [message]
            speaker=narrator
            # po: NORMAL difficulty; hint should be somewhat vague:
            message= _ "This castle is under a constant, <i>chaotic</i> time of day, except for illuminated hexes adjacent to lit stone walls. Keep this in mind when placing your units."
            image=wesnoth-icon.png
        [/message]
#endif
#ifdef HARD
        [message]
            speaker=narrator
            # po: HARD difficulty; hint should be even vaguer than on NORMAL:
            message= _ "The time of day in this castle is mostly constantly <i>chaotic</i> (exceptions apply)."
            image=wesnoth-icon.png
        [/message]
#endif
    [/event]

    [event]
        name=moveto
        [filter]
            x,y=34,4
            side=1
        [/filter]

        {VARIABLE gold_amt {ON_DIFFICULTY 100 75 50}}
        [sound]
            name=gold.ogg
        [/sound]

        [message]
            speaker=unit
            message= _ "Look what I have found in here! I can count $gold_amt pieces of gold."
        [/message]

        [gold]
            side=1
            amount=$gold_amt
        [/gold]
        {CLEAR_VARIABLE gold_amt}

        {REMOVE_IMAGE 34 4}
        {PLACE_IMAGE items/chest-plain-open.png 34 4}
    [/event]

#ifdef EASY
    [event]
        name=moveto
        [filter]
            x,y=31,14
            side=1
            [not]
                id=Brena
            [/not]
        [/filter]
        [if]
            [have_unit]
                id=Brena
            [/have_unit]
            [then]
                [message]
                    speaker=unit
                    message= _ "The wall seems a bit weaker here. I bet Brena could smash through it!"
                [/message]
            [/then]
            [else]
                [message]
                    speaker=unit
                    message= _ "The wall seems a bit weaker here... I bet Brena could have smashed through it if he were still around; shame about what happened to him..."
                [/message]
            [/else]
        [/if]
    [/event]
    [event]
        name=moveto
        [filter]
            x,y=31,14
            id=Brena
        [/filter]
        [scroll_to_unit]
            id=Brena
            highlight=yes
        [/scroll_to_unit]
        [message]
            speaker=unit
            # po: "unit" = Brena here:
            message= _ "I spy a cracked spot here. Let's see what happens if I hit it!"
        [/message]
        [animate_unit]
            flag=attack
            [filter]
                id=Brena
            [/filter]
            [primary_attack]
                range=melee
            [/primary_attack]
            [facing]
                [filter_adjacent_location]
                    adjacent=s
                    [filter]
                        id=Brena
                    [/filter]
                [/filter_adjacent_location]
            [/facing]
            hits=yes
        [/animate_unit]
        [animate_unit]
            flag=attack
            [filter]
                id=Brena
            [/filter]
            [primary_attack]
                range=melee
            [/primary_attack]
            [facing]
                [filter_adjacent_location]
                    adjacent=s
                    [filter]
                        id=Brena
                    [/filter]
                [/filter_adjacent_location]
            [/facing]
            hits=yes
        [/animate_unit]
        {QUAKE "cave-in.ogg"}
        [terrain]
            x,y=31,13
            terrain=Uhe^Dr
        [/terrain]
        [terrain]
            x,y=31,12
            terrain=Uh^Dr
        [/terrain]
        [scroll_to]
            x,y=31,12
        [/scroll_to]
        [redraw]
            clear_shroud=yes
        [/redraw]
    [/event]
#else
    [event]
        name=moveto
        [filter]
            x,y=31,14
            side=1
        [/filter]
        [message]
            speaker=unit
            message= _ "Hm, you'd think a recessed spot in the wall like this might reveal a weak spot... but alas, no such luck!"
        [/message]
    [/event]
#endif

#ifdef DEBUG_MODE
    # book 1:
    # title ideas: "The Dark Ways", ...uh... etc.
    [event]
        name=moveto
        [filter]
            x,y=2,9
            side=1
        [/filter]
#ifdef EASY
#endif
#ifdef NORMAL
#endif
#ifdef HARD
#endif
    [/event]

    # book 2:
    [event]
        name=moveto
        [filter]
            x,y=3,9
            side=1
        [/filter]
#ifdef EASY
#endif
#ifdef NORMAL
#endif
#ifdef HARD
#endif
    [/event]
#endif

    # cell door:
    [event]
        name=moveto
        [filter]
            [filter_location]
                [filter_adjacent_location]
                    x,y=6,10
                [/filter_adjacent_location]
            [/filter_location]
            side=1
        [/filter]
#ifdef EASY
        [message]
            speaker=unit
            message= _ "Hm, let's see what's in here..."
        [/message]
        [terrain]
            x,y=6,10
            terrain=Uu^Qov
        [/terrain]
        [redraw]
            side=1
            clear_shroud=yes
        [/redraw]
        [message]
            speaker=unit
            message= _ "...nope, nothing."
        [/message]
#endif
#ifdef NORMAL
        [message]
            speaker=unit
            message= _ "Hm, that's strange; there seems to be some sort of enchantment on this door preventing me from seeing into this cell..."
        [/message]
#endif
#ifdef HARD
        [message]
            speaker=unit
            message= _ "Oh hey, I think that this cell door will open for me; let's see what's inside..."
        [/message]
        [scroll_to]
            x,y=6,10
        [/scroll_to]
        [lock_view][/lock_view]
        {REMOVE_IMAGE 6 10}
        [terrain]
            x,y=6,10
            terrain=Uu^Pr\o
        [/terrain]
        [redraw]
            side=1
            clear_shroud=yes
        [/redraw]
#define WITH_ANIM
    [+unit]
        animate=yes
    [/unit]
#enddef
        {LOYAL_UNIT 2 (Draug) 4 11} {WITH_ANIM}
        {LOYAL_UNIT 2 (Draug) 5 11} {WITH_ANIM}
        {LOYAL_UNIT 2 (Draug) 5 12} {WITH_ANIM}
        {LOYAL_UNIT 2 (Draug) 6 11} {WITH_ANIM}
#undef WITH_ANIM
        [redraw]
            side=1
            clear_shroud=yes
        [/redraw]
        [unlock_view][/unlock_view]
        [message]
            speaker=unit
            # po: a yelp of terror at having discovered the Draugs:
            message= _ "...aieee!" # wmllint: no spellcheck
        [/message]
#endif
    [/event]

    # bones:
    [event]
        name=moveto
        [filter]
            x,y=9,6
            side=1
        [/filter]
#ifdef EASY
        [message]
            speaker=unit
            message= _ "Some bones... I guess sometimes people must die in these dungeons..."
        [/message]
#else
        [message]
            speaker=unit
            message= _ "...wait a moment."
        [/message]
        [move_unit]
            id=$unit.id
            dir=sw
        [/move_unit]
        [modify_unit]
            [filter]
                id=$unit.id
            [/filter]
            facing=ne
        [/modify_unit]
        [store_unit]
            [filter]
                id=$unit.id
            [/filter]
            variable=orig_unit
        [/store_unit]
        [redraw][/redraw]
        {REMOVE_IMAGE 9 6}
        [unit]
#ifdef NORMAL
            type=Skeleton
            ai_special=guardian
            moves=0
            attacks_left=0
            [status]
                slowed=yes
            [/status]
            passable=yes
            random_traits=yes
#else
            # HARD:
            type=Revenant
            upkeep=loyal
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_STRONG}
                {TRAIT_RESILIENT}
            [/modifications]
            {IS_LOYAL}
            overwrite=yes
#endif
            x,y=9,6
            side=2
            facing=sw
            animate=yes
        [/unit]
        [redraw][/redraw]
        [message]
            speaker=$orig_unit.id
            message= _ "I knew it! I knew there was something suspicious about those bones!"
        [/message]
        {CLEAR_VARIABLE orig_unit}
#endif
    [/event]

#ifdef DEBUG_MODE
    # NW drake statue:
    [event]
        name=moveto
        [filter]
            x,y=12,2
            side=1
        [/filter]
#ifdef EASY
#endif
#ifdef NORMAL
#endif
#ifdef HARD
#endif
    [/event]

    # NE drake statue:
    [event]
        name=moveto
        [filter]
            x,y=26,2
            side=1
        [/filter]
#ifdef EASY
#endif
#ifdef NORMAL
#endif
#ifdef HARD
#endif
    [/event]
#endif

    # altar:
    [event]
        name=moveto
        [filter]
            x,y=29,3
            side=1
        [/filter]
#ifdef EASY
        [message]
            speaker=unit
            message= _ "This must be where they perform unholy rituals to reanimate the dead... we had best stay away from it."
        [/message]
#endif
#ifdef NORMAL
        [redraw][/redraw]
#endif
#ifdef HARD
        [message]
            speaker=unit
            message= _ "Ugh, I don't feel so good..."
        [/message]
        [modify_unit]
            [filter]
                id=$unit.id
            [/filter]
            [status]
                poisoned=yes
            [/status]
        [/modify_unit]
        [sound]
            name=poison.ogg
        [/sound]
        # TODO: maybe something else?
#endif
    [/event]

    [event]
        name=moveto

        [filter_condition]
            [have_location]
                x,y=5,5

                [filter_vision]
                    side=1
                [/filter_vision]
            [/have_location]
        [/filter_condition]

        [scroll_to]
            x,y=3,3
        [/scroll_to]

        # wmllint: who RESTORE_BARAN is Baran
        {RESTORE_BARAN}
        {NEED_BARAN (x,y=3,3)}

        [redraw]
            side=1
        [/redraw]

        [message]
            speaker=unit
            message= _"I found Baran. He is in this cell."
        [/message]

        [if]
            [variable]
                name=unit.id
                equals="Arvith"
            [/variable]
            [then]
                [message]
                    speaker=Baran
                    message= _ "It’s good to see you, Arvith."
                [/message]

                [message]
                    speaker=Arvith
                    message= _ "And you too, brother."
                [/message]

                [message]
                    speaker=Baran
                    message= _ "The accursed dark sorcerer Rotharik has imprisoned me behind this magically enhanced iron gate. It can only be opened with the correct key. You must get it from him to free me."
                [/message]
            [/then]
            [elseif]
                [variable]
                    name=unit.id
                    equals="Muff Toras"
                [/variable]
                [then]
                    [message]
                        speaker=Baran
                        # po: Baran is reacting to Muff Toras having found him, and is speaking to him:
                        message= _ "You! You were one of my kidnappers! Why have you returned, to torture me, I assume? Well, you won't break me!"
                    [/message]
                    [message]
                        speaker=Muff Toras
                        # po: Muff Toras tries to quiet Baran and explain the situation to him:
                        message= _ "Shush! I'm not here to harm you! Your brother Arvith captured me, but he spared my life, so I work for him now! We're going to get you out of here!"
                    [/message]
                    [message]
                        speaker=Baran
                        # po: "deliver" as in "deliver on your promise of freeing me":
                        message= _ "Hm... I can't say I really trust you after you kidnapped me once, but then again, it's not like I have much choice here, so I might as well wait to see if you can deliver..."
                    [/message]
                    [message]
                        speaker=Muff Toras
                        message= _ "That's all I ask."
                    [/message]
                    [message]
                        speaker=Baran
                        # po: https://tvtropes.org/pmwiki/pmwiki.php/Main/AsYouKnow
                        message= _ "Well, as one of my kidnappers, you must already know that I can't just fireball my way out of here, due to the magical enhancements your master — er, I mean, FORMER master Rotharik made to this iron gate."
                    [/message]
                    [message]
                        speaker=Muff Toras
                        message= _ "That's correct; it can only be opened with the correct key. We are working on getting it from Rotharik in order to free you."
                    [/message]
                    [message]
                        speaker=Baran
                        message= _ "You'd better be!"
                    [/message]
                [/then]
            [/elseif]
            [else]
                [message]
                    speaker=Baran
                    message= _ "You must be one of Arvith’s men. Please help me get out of this dungeon in which the accursed dark sorcerer Rotharik has imprisoned me! The iron gate is magically enhanced and can only be opened with the correct key. You must get it from Rotharik to free me!"
                [/message]
            [/else]
        [/if]

        [if]
            [not]
                [have_unit]
                    id=Rotharik
                [/have_unit]
            [/not]
            [then]
                [message]
                    speaker=Arvith
                    message= _ "I have already met, and killed, the sorcerer. Is this the key to which you referred?"
                [/message]
                [message]
                    speaker=Baran
                    message= _ "Yes, it is. Come, unlock this cell door, and let us depart this place, brother!"
                [/message]

                [store_turns]
                    variable=turns_remaining
                [/store_turns]
                [set_variable]
                    name=turns_remaining
                    sub=$($turn_number| - 1)
                [/set_variable]
                [if]
                    [variable]
                        name=turns_remaining
                        less_than=7
                    [/variable]
                    [then]
                        [modify_turns]
                            add=$(7 - $turns_remaining|)
                        [/modify_turns]
                    [/then]
                [/if]
                {CLEAR_VARIABLE turns_remaining}
            [/then]
        [/if]
        [show_objectives][/show_objectives]

#ifdef EASY
        [message]
            speaker=narrator
            image="wesnoth-icon.png"
            # po: "we" here is the "royal we":
            message= _ "You can now control Baran! However, as he will remain imprisoned for the remainder of this scenario, we shall wait until the next one to give you tips on using him."
        [/message]
#endif
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            x=5,6
            y=6,5
            id=Arvith
        [/filter]
        [filter_condition]
            [not]
                [have_unit]
                    id=Rotharik
                [/have_unit]
            [/not]
        [/filter_condition]

        [remove_item]
            x,y=5,5
        [/remove_item]

        [terrain]
            x,y=5,5
            terrain=Uu^Pr/o
        [/terrain]

        [message]
            speaker=Baran
            message= _ "Thank you for saving me. I... was not certain you would come."
        [/message]

        [message]
            speaker=Arvith
            message= _ "Have you no faith in your brother, Baran?"
        [/message]

        [message]
            speaker=Baran
            message= _ "It’s not that. Perhaps I deserved to rot here. I failed you. I failed you again."
        [/message]

        [message]
            speaker=Arvith
            message= _ "That is as may be. But you are my brother still. And... I never doubted you would have come for me."
        [/message]

        [message]
            speaker=Arvith
            message= _ "It was no great trial, after all. A few elves, one or two dark sorcerers, a gang of orcs and some undead. Really just a day’s work for the company."
        [/message]

        [message]
            speaker=Baran
            message= _ "Thank you for coming to my aid. Let us return to the village."
        [/message]

        [endlevel]
            result=victory
            bonus=yes
            {NEW_GOLD_CARRYOVER {ON_DIFFICULTY 60 50 40}}
        [/endlevel]
    [/event]

    [event]
        name=victory

        {RESTORE_BARAN}
        {CLEAR_VARIABLE first_challenge_result}
    [/event]

    {BARAN_LAST_BREATH}
    {ARVITH_LAST_BREATH}
    {MUFF_TORAS_LAST_BREATH}
    {BRENA_LAST_BREATH}

    [event]
        name=time over

        [if]
            [not]
                [have_unit]
                    id=Rotharik
                [/have_unit]
            [/not]
            [then]
                [unit]
                    id=Rotharik
                    # (he's not actually Rotharik; we're just reusing that id so the message will still fire)
                    side=2
                    type=Orcish Assassin
                    name= _ "Minion of Tairach"
                    x,y=2,2
                [/unit]
                [kill]
                    id=Baran
                [/kill]
            [/then]
        [/if]
        [message]
            # wmllint: local spelling Muahahaha
            speaker=Rotharik
            scroll=no
            # po: speaker being "Rotharik" here is an id used by both Rotharik himself and the Orcish Assassin ("Minion of Tairach")
            # po: that replaces him if he's dead; in either case, he is male:
            message= _ "You are too late! Your brother is already dead! Muahahaha...!"
        [/message]

        [message]
            speaker=Arvith
            message= _ "Argh!!"
        [/message]
        {CLEAR_VARIABLE first_challenge_result}
    [/event]
[/scenario]
